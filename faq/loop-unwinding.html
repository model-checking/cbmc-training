<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>What is loop unwinding? - CBMC</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> CBMC quick start</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installation.html"><strong aria-hidden="true">1.1.</strong> CBMC installation</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/unit-testing.html"><strong aria-hidden="true">1.2.</strong> CBMC as unit testing</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/debugging.html"><strong aria-hidden="true">1.3.</strong> CBMC as debugging</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/proof.html"><strong aria-hidden="true">1.4.</strong> CBMC as proof</a></li></ol></li><li class="chapter-item expanded "><a href="../cbmc/overview/index.html"><strong aria-hidden="true">2.</strong> CBMC proofs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cbmc/overview/cbmc.html"><strong aria-hidden="true">2.1.</strong> Running cbmc</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/loop-unwinding.html"><strong aria-hidden="true">2.2.</strong> Loop unwinding</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/checking-properties.html"><strong aria-hidden="true">2.3.</strong> Property checking</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/checking-coverage.html"><strong aria-hidden="true">2.4.</strong> Coverage checking</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/proof-harnesses.html"><strong aria-hidden="true">2.5.</strong> Proof harnesses</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/proof-assumptions.html"><strong aria-hidden="true">2.6.</strong> Proof assumptions</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/goto-programs.html"><strong aria-hidden="true">2.7.</strong> Goto programs</a></li></ol></li><li class="chapter-item expanded "><a href="../starter-kit/overview/index.html"><strong aria-hidden="true">3.</strong> CBMC proof projects</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> CBMC viewer</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Litani</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Continuous integration</div></li><li class="chapter-item expanded "><a href="../faq/index.html"><strong aria-hidden="true">7.</strong> Frequently asked questions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../faq/cbmc.html"><strong aria-hidden="true">7.1.</strong> How does CBMC work?</a></li><li class="chapter-item expanded "><a href="../faq/loop-unwinding.html" class="active"><strong aria-hidden="true">7.2.</strong> What is loop unwinding?</a></li><li class="chapter-item expanded "><a href="../faq/memory-model.html"><strong aria-hidden="true">7.3.</strong> How do memory pointers work?</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.4.</strong> How do function pointers work?</div></li><li class="chapter-item expanded "><a href="../faq/malloc.html"><strong aria-hidden="true">7.5.</strong> How does malloc work?</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.6.</strong> How do I write a good stub?</div></li><li class="chapter-item expanded "><a href="../faq/termination.html"><strong aria-hidden="true">7.7.</strong> What do I do when CBMC won't stop?</a></li></ol></li><li class="chapter-item expanded "><a href="../management/index.html"><strong aria-hidden="true">8.</strong> CBMC project management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../management/Plan-your-proof.html"><strong aria-hidden="true">8.1.</strong> Project planning</a></li><li class="chapter-item expanded "><a href="../management/Write-a-good-proof.html"><strong aria-hidden="true">8.2.</strong> Writing a good proof</a></li><li class="chapter-item expanded "><a href="../management/Debug-an-error-trace.html"><strong aria-hidden="true">8.3.</strong> Debugging an error trace</a></li><li class="chapter-item expanded "><a href="../management/Code-for-verification.html"><strong aria-hidden="true">8.4.</strong> Coding for verification</a></li><li class="chapter-item expanded "><a href="../management/Code-review-for-proofs.html"><strong aria-hidden="true">8.5.</strong> Proof evaluation</a></li></ol></li><li class="chapter-item expanded "><a href="../projects.html"><strong aria-hidden="true">9.</strong> CBMC projects</a></li><li class="chapter-item expanded "><a href="../resources.html"><strong aria-hidden="true">10.</strong> CBMC resources</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CBMC</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="what-is-loop-unwinding"><a class="header" href="#what-is-loop-unwinding">What is loop unwinding?</a></h1>
<p>CBMC is a bounded model checker.  CBMC works by
executing a program for some bounded number of steps and looking
for issues that occur within those steps.  CBMC does not execute a
program concretely in the same way that a computer would execute the program
(would execute the result of compiling the program).
Instead,
CBMC <a href="https://en.wikipedia.org/wiki/Symbolic_execution">symbolically executes</a>
the program to turn it into a set of symbolic constraints that can be solved by
a constraint solver like a SAT solver.</p>
<p>But where does this bound come from?  And how do we know the bound
is the right one?</p>
<h2 id="loop-bounds"><a class="header" href="#loop-bounds">Loop bounds</a></h2>
<p>If the program contains no loops and contains no recursion, then every
execution of the program is finite, and CBMC can figure out the length
of the longest execution and use this as the bound.  Sometime CBMC
can figure this out even when the program contains loops.  For example,
CBMC can loop at the loop</p>
<pre><code>  for (int i=0; i &lt; 10; i++)
    buffer[i] = ' ';
</code></pre>
<p>and figure out on its own that the loop iterates at most 10 times.
But CBMC needs some help with the loop</p>
<pre><code>  while (TRUE)
    if (i &lt; buffer.size) buffer.data[i] = ' ' else break;
</code></pre>
<p>We need to give CBMC a bound on the number of times this loop iterates.
We need to tell CBMC how many times to unwind this loop during its
symbolic execution of the program.</p>
<p>We can do this in two ways.</p>
<ul>
<li>
<p><strong>Bound all loops</strong>: We can instruct CBMC to unwind every loop at
most <code>K</code> times with <code>cbmc --unwind K</code>. If you are using the CBMC
starter kit, this bound 1 by default, but you can change this
to <code>K</code> in your Makefile with</p>
<pre><code>  UNWIND=K
</code></pre>
</li>
<li>
<p><strong>Bound one loop</strong>: We can instruct CBMC to unwind a specific loop
at most <code>K</code> times with <code>cbmc --unwindset FUNC.NUM:K</code> where <code>FUNC</code>
is the name of the function containing the loop and <code>NUM</code> is the
number of the loop within the function (more on loop numbers below).
If you are using the CBMC starter kit, we recommend that you set
this bound in your Makefile with</p>
<pre><code>   UNWINDSET+=FUNC.NUM:K
</code></pre>
</li>
</ul>
<h2 id="loop-unwinding-assertions"><a class="header" href="#loop-unwinding-assertions">Loop unwinding assertions</a></h2>
<p>Now we know how to tell CBMC to unwind a loop <code>K</code> times, but how do we
know that unwinding a loop <code>K</code> times is enough?  What if the problem
we are looking for occurs on iteration <code>K+1</code> and we have asked CBMC to
unwind the loop only <code>K</code> times?  We could miss the issue and never know
it because we didn't tell CBMC to work hard enough to find it!</p>
<p>CBMC has solution called &quot;loop unwinding assertions.&quot;
A loop unwinding assertion is a check that a loop has been completely unwound.
It checks that the loop termination condition is guaranteed to be true
after the specified number of unwindings.
First CBMC unwinds the loop, and then CBMC inserts a assertion that
the loop termination condition is true immediately after the final
unwinding of the loop.
If there is any execution of the program in which you haven't unwound
the loop enough times, CBMC will identify the loop by its
loop name <code>FUNC.NUM</code> in the list of checks that have failed.</p>
<p>Invoking CBMC with <code>cbmc --unwinding-assertions</code> will ask CBMC to check
unwinding assertions.</p>
<center>Always invoke CBMC with <code>cbmc --unwinding-assertions</code>.</center>
<p>You can rest assured that CBMC is always invoked
with <code>cbmc --unwinding-assertions</code> if you are using the CBMC starter kit.</p>
<h2 id="counting-loop-iterations"><a class="header" href="#counting-loop-iterations">Counting loop iterations</a></h2>
<p>There are two ways to count loop iterations:</p>
<ul>
<li>One is the number of times <code>B</code> that the loop body is traversed.</li>
<li>One is the number of times <code>T</code> that the loop termination is checked.</li>
</ul>
<p>These two numbers differ by one: <code>T = B + 1</code>.</p>
<p>When you invoke CBMC, the number <code>K</code> that you give to <code>--unwind</code> or
<code>--unwindset</code> is interpreted as the number of times the loop termination
is checked: <code>K = T = B+1</code>.</p>
<p>This off-by-one business sometimes confuses people, and sometimes makes
it challenging to write a Makefile where arithmetic like <code>B+1</code> is difficult.
One style we have developed is to write a proof harness</p>
<pre><code class="language-C">int main() {
  size_t length;
  __CPROVER_assume(length &lt; LENGTH);

  char *buffer = (char *) malloc(length);
  for (int i=0; i &lt; length; i++) buffer[i] = ' ';
  ...
}
</code></pre>
<p>and to write a Makefile</p>
<pre><code class="language-Makefile">LENGTH=100
DEFINES += -DLENGTH=$(LENGTH)
UNWINDSET += main.0:$(LENGTH)
</code></pre>
<p>Because <code>length</code> is assumed to be strictly less than <code>LENGTH</code>, we know
that <code>length + 1</code> is at most <code>LENGTH</code>, so unwinding the loop <code>main.0</code>
at most <code>LENGTH</code> times is unwinding the loop at least <code>length + 1</code> times
as desired.</p>
<p>A final comment on this off-by-one issue:
At some point in the future, you may come to learn that
you can also pass the <code>cbmc</code> flags <code>--unwind</code> and <code>--unwindset</code> to a tool
named <code>goto-instrument</code>.  For historical reasons, <code>cbmc</code> interprets <code>K</code> as
<code>K=T</code> and <code>goto-instrument</code> interprets <code>K</code> as <code>K=B</code>.
Of course, when choosing between unrolling a loop <code>T=B+1</code> and <code>B</code> times,
it is always safe to unroll a loop more times than necessary.
But it may not be practical: If the loop body is
large and you are already unrolling a loop many times, the difference between
unrolling <code>K</code> and <code>K+1</code> times many push CBMC execution time from &quot;okay&quot;
to &quot;way too long.&quot;
Just something to keep in mind when using these tools.</p>
<h2 id="debugging-loop-unwinding"><a class="header" href="#debugging-loop-unwinding">Debugging loop unwinding</a></h2>
<p>When not using the starter kit, which uses <code>--unwind 1</code> by default, you may find
yourself in a situation where CBMC keeps unwinding a loop, even when you
expected CBMC to be able to determine the loop bound. CBMC uses constant
propagation and algebraic simplification to evaluate the loop guard.  CBMC will
stop unwinding the loop when, using this process, the loop guard evaluates to
false. If you would like to debug a case of unexpected loop unwinding, proceed
as described below. We will use the following example to illustrate these steps:</p>
<pre><code class="language-C">int main()
{
  int step;
  for(int i = 0; i &lt; 5; i += step) ;
}
</code></pre>
<p>Note that <code>step</code> is unconstrained, perhaps unintentionally so.
Running CBMC on this example without any additional options yields:</p>
<pre><code>&gt; cbmc loop.c
[...]
Starting Bounded Model Checking
Unwinding loop main.0 iteration 1 file loop.c line 4 function main thread 0
Unwinding loop main.0 iteration 2 file loop.c line 4 function main thread 0
Unwinding loop main.0 iteration 3 file loop.c line 4 function main thread 0
Unwinding loop main.0 iteration 4 file loop.c line 4 function main thread 0
Unwinding loop main.0 iteration 5 file loop.c line 4 function main thread 0
Unwinding loop main.0 iteration 6 file loop.c line 4 function main thread 0
Unwinding loop main.0 iteration 7 file loop.c line 4 function main thread 0
Unwinding loop main.0 iteration 8 file loop.c line 4 function main thread 0
Unwinding loop main.0 iteration 9 file loop.c line 4 function main thread 0
Unwinding loop main.0 iteration 10 file loop.c line 4 function main thread 0
[...]
</code></pre>
<p>until you manually abort this process. One way to understand why this is
happening is to undertake the following steps:</p>
<ol>
<li>Run CBMC with whatever options you normally do, but add some finite unrolling
bound using <code>--unwind</code> and also add <code>--program-only</code>. This will yield as
output the equation system generate by symbolic execution. Pipe the output to
some text file. We exemplify this on the above example:
<pre><code>&gt; cbmc loop.c --program-only --unwind 2
[...]
Starting Bounded Model Checking
Unwinding loop main.0 iteration 1 file loop.c line 4 function main thread 0
Not unwinding loop main.0 iteration 2 file loop.c line 4 function main thread 0
[...]
Program constraints:
[...]
// 2 file loop.c line 4 function main
(26) i!0@1#2 == 0
// 3 file loop.c line 4 function main
// 4 file loop.c line 4 function main
(27) i!0@1#3 == step!0@1#1
// 5 file loop.c line 4 function main
// 3 file loop.c line 4 function main
// 3 file loop.c line 4 function main
(28) \guard#1 == !(i!0@1#3 &gt;= 5)
// 4 file loop.c line 4 function main
(29) i!0@1#4 == i!0@1#3 + step!0@1#1
     guard: \guard#1
[...]
</code></pre>
The above output is an excerpt from the equation system generated by symbolic
execution. We see assignments to the loop counter <code>i</code> turned into equations
over its renamed (in static single assignment (SSA) form) instantiations. The
loop guard is found as <code>\guard#1</code>.</li>
<li>Search for the source location where you expect the constant to appear in the
loop guard. In our example, this is &quot;file loop.c line 4.&quot;</li>
<li>Once you have found the assignment or equality defining the loop guard that
doesn't have the expected constant on the right-hand side (in the example,
this could be the equality over <code>\guard#1</code>), work backwards
from that right-hand side to see where you last had a constant. That is,
backwards-search for the name appearing on the right-hand side, which will
eventually appear as a left-hand side. Now repeat this process for the new
right-hand side of this equation, until the right-hand side is a constant. In
the example, the only time we find a constant as right-hand side is the
initial assignment, <code>i!0@1#2 == 0</code>.</li>
<li>The expression where you flip from is-a-constant to is-a-symbol is the
culprit. For our example, this is <code>i!0@1#3 == step!0@1#1</code>. You will then
conclude that either this behavior is as expected, meaning your source
program does not permit constant propagation (our example does not permit
constant propagation, because <code>step</code> is unconstrained; setting it to some
constant value will result in bounded loop unwinding), or a shortcoming in
CBMC's simplification process. In the latter case, report an issue or
contribute a patch to address this.</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../faq/cbmc.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../faq/memory-model.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../faq/cbmc.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../faq/memory-model.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
