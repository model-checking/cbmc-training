<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>CBMC as proof - CBMC</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../index.html"><strong aria-hidden="true">1.</strong> CBMC quick start</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../installation.html"><strong aria-hidden="true">1.1.</strong> CBMC installation</a></li><li class="chapter-item expanded "><a href="../../cbmc/overview/unit-testing.html"><strong aria-hidden="true">1.2.</strong> CBMC as unit testing</a></li><li class="chapter-item expanded "><a href="../../cbmc/overview/debugging.html"><strong aria-hidden="true">1.3.</strong> CBMC as debugging</a></li><li class="chapter-item expanded "><a href="../../cbmc/overview/proof.html" class="active"><strong aria-hidden="true">1.4.</strong> CBMC as proof</a></li></ol></li><li class="chapter-item expanded "><a href="../../cbmc/overview/index.html"><strong aria-hidden="true">2.</strong> CBMC proofs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../cbmc/overview/cbmc.html"><strong aria-hidden="true">2.1.</strong> Running cbmc</a></li><li class="chapter-item expanded "><a href="../../cbmc/overview/loop-unwinding.html"><strong aria-hidden="true">2.2.</strong> Loop unwinding</a></li><li class="chapter-item expanded "><a href="../../cbmc/overview/checking-properties.html"><strong aria-hidden="true">2.3.</strong> Property checking</a></li><li class="chapter-item expanded "><a href="../../cbmc/overview/checking-coverage.html"><strong aria-hidden="true">2.4.</strong> Coverage checking</a></li><li class="chapter-item expanded "><a href="../../cbmc/overview/proof-harnesses.html"><strong aria-hidden="true">2.5.</strong> Proof harnesses</a></li><li class="chapter-item expanded "><a href="../../cbmc/overview/proof-assumptions.html"><strong aria-hidden="true">2.6.</strong> Proof assumptions</a></li><li class="chapter-item expanded "><a href="../../cbmc/overview/goto-programs.html"><strong aria-hidden="true">2.7.</strong> Goto programs</a></li></ol></li><li class="chapter-item expanded "><a href="../../starter-kit/overview/index.html"><strong aria-hidden="true">3.</strong> CBMC proof projects</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> CBMC viewer</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Litani</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Continuous integration</div></li><li class="chapter-item expanded "><a href="../../faq/index.html"><strong aria-hidden="true">7.</strong> Frequently asked questions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../faq/cbmc.html"><strong aria-hidden="true">7.1.</strong> How does CBMC work?</a></li><li class="chapter-item expanded "><a href="../../faq/loop-unwinding.html"><strong aria-hidden="true">7.2.</strong> What is loop unwinding?</a></li><li class="chapter-item expanded "><a href="../../faq/memory-model.html"><strong aria-hidden="true">7.3.</strong> How do memory pointers work?</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.4.</strong> How do function pointers work?</div></li><li class="chapter-item expanded "><a href="../../faq/malloc.html"><strong aria-hidden="true">7.5.</strong> How does malloc work?</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.6.</strong> How do I write a good stub?</div></li><li class="chapter-item expanded "><a href="../../faq/termination.html"><strong aria-hidden="true">7.7.</strong> What do I do when CBMC won't stop?</a></li></ol></li><li class="chapter-item expanded "><a href="../../management/index.html"><strong aria-hidden="true">8.</strong> CBMC project management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../management/Plan-your-proof.html"><strong aria-hidden="true">8.1.</strong> Project planning</a></li><li class="chapter-item expanded "><a href="../../management/Write-a-good-proof.html"><strong aria-hidden="true">8.2.</strong> Writing a good proof</a></li><li class="chapter-item expanded "><a href="../../management/Debug-an-error-trace.html"><strong aria-hidden="true">8.3.</strong> Debugging an error trace</a></li><li class="chapter-item expanded "><a href="../../management/Code-for-verification.html"><strong aria-hidden="true">8.4.</strong> Coding for verification</a></li><li class="chapter-item expanded "><a href="../../management/Code-review-for-proofs.html"><strong aria-hidden="true">8.5.</strong> Proof evaluation</a></li></ol></li><li class="chapter-item expanded "><a href="../../projects.html"><strong aria-hidden="true">9.</strong> CBMC projects</a></li><li class="chapter-item expanded "><a href="../../resources.html"><strong aria-hidden="true">10.</strong> CBMC resources</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CBMC</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="cbmc-as-proof"><a class="header" href="#cbmc-as-proof">CBMC as proof</a></h1>
<p>Think of CBMC as a tool for doing mathematical proof. CBMC does an
exhaustive search for issues affecting functional correctness and
memory safety.  If CBMC finds an issue, <a href="debugging.html">as we have seen</a>,
then CBMC has likely found a bug.
But if CBMC does <em>not</em> find any issues, then you can rest assured
that the issues like memory safety that you are asking CBMC to check for
will not occur in your program with the inputs you are asking CBMC to check.</p>
<p>We note, however, that using CBMC may require bounding the size of the inputs
you are asking CBMC to check.
It may be necessary, for example, to assume that packets
coming off the network are of size at most 1024 bytes
in order to fit the problem into CBMC.
We refer to assumptions like this as <em>proof assumptions</em>.
It is important to remember that proof assumptions exists,
and to communicate them clearly to the reader or consumer of
any proof you write with CBMC.</p>
<p>Let's look again at <a href="examples/simple/memory-safety.c">memory-safety.c</a></p>
<pre><code class="language-c">#define SIZE 20
char buffer[SIZE];

char read_buffer(int i)  { return buffer[i];     }
char read_pointer(int i) { return *(buffer + i); }

int main() {
  int index;
  read_buffer(index);
  read_pointer(index);
}
</code></pre>
<p>that we found to have <a href="debugging.html#memory-safety">memory safety issues</a>
in the last section.  The problem was obviously the lack of bounds checking
in the code.  Let's fix that.</p>
<h2 id="memory-safety-proof"><a class="header" href="#memory-safety-proof">Memory safety proof</a></h2>
<p>Let's try adding bounds checking.
Consider <a href="examples/simple/memory-safety1.c">memory-safety1.c</a></p>
<pre><code class="language-c">#define SIZE 20
char buffer[SIZE];

char read_buffer(int i)  {
  if (i &lt; SIZE) return buffer[i];
  return '\0';
}
char read_pointer(int i) {
  if (i &lt; SIZE) return *(buffer + i);
  return '\0';
}

int main() {
  int index;
  read_buffer(index);
  read_pointer(index);
}
</code></pre>
<p>We probably want better error handling than just returning <code>NULL</code>,
but let's run CBMC to prove memory safety:</p>
<pre><code class="language-bash">cbmc memory-safety1.c --bounds-check --pointer-check
</code></pre>
<pre><code>** Results:
memory-safety1.c function read_buffer
[read_buffer.array_bounds.1] line 10
  array 'buffer' lower bound in buffer[(signed long int)i]: FAILURE
[read_buffer.array_bounds.2] line 10
  array 'buffer' upper bound in buffer[(signed long int)i]: SUCCESS

memory-safety1.c function read_pointer
[read_pointer.pointer_dereference.1] line 14
  dereference failure: pointer outside object bounds in buffer[(signed long int)i]:
  FAILURE

** 2 of 3 failed (2 iterations)
VERIFICATION FAILED
</code></pre>
<p>Oh, nuts.  We failed.  We added bounds checking only for the upper bound.</p>
<h2 id="memory-safety-proof-20"><a class="header" href="#memory-safety-proof-20">Memory safety proof 2.0</a></h2>
<p>Let's try adding bounds checking for both the upper and lower bounds.
Consider <a href="examples/simple/memory-safety2.c">memory-safety2.c</a></p>
<pre><code class="language-c">#define SIZE 20
char buffer[SIZE];

char read_buffer(int i)  {
  if (0 &lt;= i &amp;&amp; i &lt; SIZE) return buffer[i];
  return '\0';
}
char read_pointer(int i) {
  if (0 &lt;= i &amp;&amp; i &lt; SIZE) return *(buffer + i);
  return '\0';
}

int main() {
  int index;
  read_buffer(index);
  read_pointer(index);
}
</code></pre>
<p>and run CBMC</p>
<pre><code class="language-bash">cbmc memory-safety2.c --bounds-check --pointer-check
</code></pre>
<pre><code>** 0 of 3 failed (1 iterations)
VERIFICATION SUCCESSFUL
</code></pre>
<p>and declare victory.</p>
<h2 id="memory-safety-proof-harness"><a class="header" href="#memory-safety-proof-harness">Memory safety proof harness</a></h2>
<p>Let's pivot back to the notion of a proof harness before we declare
complete victory.</p>
<p>Back when we introduced <a href="unit-testing.html">CBMC as a form of unit testing</a>,
we had a function <a href="quartile.c">quartile</a> under test
and a <a href="unit-test.c">unit test</a> for <code>quartile</code>.
The unit test set up the software environment for the function under test
and invoked the function.
The function <code>quartile</code> was so simple that all the unit test had to do
was initialize the argument <code>x</code> passed to <code>quartile</code> and invoke
<code>quartile</code> on <code>x</code>.
Then we removed the initialization of <code>x</code> so that CBMC could consider
all possible integer values for the argument <code>x</code>.
We transformed the unit test into what we call a <em>proof harness</em> for
the function <code>quartile</code> and used that with CBMC.</p>
<p>We routinely find ourselves with a library and wanting to use
CBMC to prove that all of the public entry points in the library's
API are memory safe.
Our style is to write a memory safety proof for each entry point
independently.
We write one proof harness for each entry point.  The purpose
of the proof harness is to model the software environment in which
the entry point will be called.  The proof harness will always have
to model the inputs to the entry point.  But the proof harness might
also have to model some aspects of the global state if, for example,
there is a system table accessed by the entry point.</p>
<p>In the ideal world,
a proof harness will construct arbitrary, unconstrained values for
every variable and data structure in the software environment of an
entry point, and invoke the entry point.
In the real world,
the entry point makes some assumptions about its inputs.
It may, at the very least, assume that the system table is well-formed
in the sense that it satisfies some data structure invariant.
In the ideal world, the proof author will talk with the code author
and convince the developer to write more bullet-proof code.
In the real world,
the proof author will model these assumptions in the proof harness
to prove memory safety.
But now these assumptions become part of the proof:
CBMC has demonstrated that the entry point is memory safe,
but only when the assumptions described in the proof harness are true when
the entry point is invoked.
A developer might want to include in the testing framework some
checks that these assumptions really are true at all call sites calling
the entry point.
Or a developer might want to use CBMC to prove this...</p>
<p>But let's return to our memory safety example and transform it into
something you are more likely to encounter in the real world.</p>
<h3 id="the-library"><a class="header" href="#the-library">The library</a></h3>
<p>First, the buffer and the accessor functions are likely to
be part of a library.
Here is <a href="examples/simple/library.h">library.h</a></p>
<pre><code class="language-c">char read_buffer(int i);
char read_pointer(int i);
</code></pre>
<p>and <a href="examples/simple/library.c">library.c</a></p>
<pre><code class="language-c">#include &quot;library.h&quot;

#define SIZE 20
char buffer[SIZE];

char read_buffer(int i)  {
  if (0 &lt;= i &amp;&amp; i &lt; SIZE) return buffer[i];
  return '\0';
}
char read_pointer(int i) {
  if (0 &lt;= i &amp;&amp; i &lt; SIZE) return *(buffer + i);
  return '\0';
}
</code></pre>
<h3 id="the-proof-harnesses"><a class="header" href="#the-proof-harnesses">The proof harnesses</a></h3>
<p>Second, we write one proof harness for each entry point.
Here is <a href="examples/simple/read_buffer_harness.c">read_buffer_harness.c</a></p>
<pre><code class="language-c">#include &quot;library.h&quot;

harness() {
  int index;
  read_buffer(index);
}
</code></pre>
<p>and <a href="examples/simple/read_pointer_harness.c">read_pointer_harness.c</a></p>
<pre><code class="language-c">#include &quot;library.h&quot;

harness() {
  int index;
  read_pointer(index);
}
</code></pre>
<p>Notice that we have changed the function name from <code>main</code> to <code>harness</code> in
these proof harnesses.  This is not essential, it is just a matter of style,
but it does avoid name conflicts with a real <code>main</code> that might exist in
the real environment.</p>
<h3 id="the-proof"><a class="header" href="#the-proof">The proof</a></h3>
<p>Now we can run the proofs just as before, giving both the library
and the proof harness on the command line, and also indicating to CBMC
that the function to test is now called <code>harness</code> and not <code>main</code>:</p>
<pre><code class="language-bash">cbmc library.c read_buffer_harness.c --bounds-check --pointer-check --function harness
cbmc library.c read_pointer_harness.c --bounds-check --pointer-check --function harness
</code></pre>
<p>In both cases:</p>
<pre><code>** 0 of 3 failed (1 iterations)
VERIFICATION SUCCESSFUL
</code></pre>
<p>Success!!</p>
<h3 id="building-code-for-proof"><a class="header" href="#building-code-for-proof">Building code for proof</a></h3>
<p>One last thing.
In the real world, the library is not this simple.
There is probably a build process to compile the source code into a library
using a compiler like <code>gcc</code>.</p>
<p>One approach is to build the library using <code>goto-cc</code> in place of <code>gcc</code>.
The compiler <code>goto-cc</code> is intended to be a drop-in replacement for <code>gcc</code>.
Using <code>goto-cc</code> should be as easy as building with <code>CC=goto-cc</code> in place
of <code>CC=gcc</code>.
The difference is that <code>goto-cc</code> produces an intermediate representation for
the program called
a &quot;goto program&quot; or &quot;goto binary&quot; that is used by CBMC for model checking.
When we run <code>cbmc</code>
directly on a source file, CBMC is invoking <code>goto-cc</code> on the source file
before model checking, but we can run <code>goto-cc</code> ourselves to build the
goto program, and run CBMC on that.</p>
<p>Our approach, however, is not to build the entire library.  There are
performance and complexity issues that we won't go into here related to
symbolic execution and constraint solving.
We usually build only the portions of the library that are required to
prove that a particular entry point is memory safe.</p>
<p>Using our simple library above to illustrate, we would build and prove
memory safe the entry point <code>read_buffer</code> as follows:</p>
<pre><code class="language-bash">goto-cc library.c -o library.goto
goto-cc read_buffer_harness.c -o read_buffer_harness.goto
goto-cc library.goto read_buffer_harness.goto -o read_buffer.goto --function harness
cbmc read_buffer.goto --bounds-check --pointer-check
</code></pre>
<p>The first two lines build the source files, the third links them
together (and identifies <code>harness</code> as the entry point), and the fourth line
runs CBMC on the result.  The process for <code>read_pointer</code> is similar.</p>
<p>Now, finally, and forever:</p>
<pre><code>** 0 of 3 failed (1 iterations)
VERIFICATION SUCCESSFUL
</code></pre>
<p>Success!!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../cbmc/overview/debugging.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../../cbmc/overview/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../cbmc/overview/debugging.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../cbmc/overview/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
